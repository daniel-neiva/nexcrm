generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "linux-arm64-openssl-3.0.x", "rhel-openssl-1.0.x", "darwin-arm64"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===== NexCRM Schema =====

model Account {
  id        String   @id @default(cuid())
  name      String
  phone     String?
  language  String   @default("pt-BR")
  plan      String   @default("free")
  autoResolvedays Int @default(30)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users         User[]
  contacts      Contact[]
  conversations Conversation[]
  labels        Label[]
  teams         Team[]
  agents        Agent[]
}

model User {
  id        String   @id @default(cuid())
  authId    String   @unique // Supabase Auth ID
  name      String
  email     String   @unique
  avatarUrl String?
  role      Role     @default(AGENT)
  status    UserStatus @default(OFFLINE)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  accountId String
  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  assignedConversations Conversation[] @relation("assignee")
  messages              Message[]
  notifications         Notification[]
  teams                 TeamMember[]
}

model Contact {
  id               String   @id @default(cuid())
  name             String?
  email            String?
  phone            String?
  avatarUrl        String?
  customAttributes Json?    @default("{}")
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  accountId String
  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  conversations Conversation[]
  labels        ContactLabel[]
}

model Conversation {
  id                  String             @id @default(cuid())
  whatsappJid         String?            @unique
  status              ConversationStatus @default(OPEN)
  channel             Channel            @default(WEB)
  unreadCount         Int                @default(0)
  readOverrideUntil   DateTime?
  lastReadMessageId   String?
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt

  accountId  String
  account    Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  contactId  String
  contact    Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  assigneeId String?
  assignee   User?   @relation("assignee", fields: [assigneeId], references: [id], onDelete: SetNull)

  agentId    String?
  agent      Agent?  @relation(fields: [agentId], references: [id], onDelete: SetNull)

  messages   Message[]
  labels     ConversationLabel[]
}

model Message {
  id           String      @id @default(cuid())
  whatsappId   String?     @unique
  whatsappJid  String?
  content      String
  type         String      @default("text") // text, image, video, audio, document, sticker
  fromMe       Boolean     @default(false)
  isRead       Boolean     @default(false)
  sender       SenderType
  senderName   String?
  fileUrl      String?
  fileName     String?
  createdAt    DateTime    @default(now())

  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  userId    String?
  user      User?   @relation(fields: [userId], references: [id], onDelete: SetNull)
}

model Agent {
  id          String @id @default(cuid())
  name        String
  roleDescription String @db.Text @default("Agente de atendimento corporativo.")
  
  // Settings - Voice & Timing
  voiceType   VoiceType @default(FEMALE)
  messageGrouping Boolean @default(true)
  groupingDelay Int @default(15) // seconds before reply
  
  // Settings - Behavior
  humanHandoffRules String @db.Text @default("Redirecione para humano em caso de reclamação.")
  timeBasedRouting Boolean @default(false)
  
  // Settings - Company Context
  companyName String @default("Minha Empresa")
  companyUrl  String?
  companyDescription String? @db.Text
  
  // Settings - Personality
  communicationStyle String @default("PROFESSIONAL") // Mapped from Enums later
  
  // AI System Params
  prompt      String    @db.Text
  flow        String    @default("QUALIFICATION")
  
  // Operational
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  accountId String
  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  conversations Conversation[]
  knowledgeData AgentKnowledge[]
  attributes AgentAttribute[]
}

model AgentKnowledge {
  id        String   @id @default(cuid())
  tagName   String   // e.g "Postura do Agente", "Tabela de Preços"
  content   String   @db.Text
  agentId   String
  agent     Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AgentAttribute {
  id        String   @id @default(cuid())
  fieldType String   // e.g "NOME", "CPF", "ENDERECO", "TELEFONE"
  description String @db.Text
  isRequired Boolean @default(false)
  
  agentId   String
  agent     Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Label {
  id          String  @id @default(cuid())
  name        String
  description String?
  color       String  @default("#3B82F6")
  createdAt   DateTime @default(now())

  accountId String
  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  contacts      ContactLabel[]
  conversations ConversationLabel[]

  @@unique([accountId, name])
}

model ContactLabel {
  contactId String
  contact   Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)
  labelId   String
  label     Label   @relation(fields: [labelId], references: [id], onDelete: Cascade)

  @@id([contactId, labelId])
}

model ConversationLabel {
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  labelId        String
  label          Label        @relation(fields: [labelId], references: [id], onDelete: Cascade)

  @@id([conversationId, labelId])
}

model Team {
  id          String  @id @default(cuid())
  name        String
  description String?
  createdAt   DateTime @default(now())

  accountId String
  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  members   TeamMember[]
}

model TeamMember {
  userId String
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)
  teamId String
  team   Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@id([userId, teamId])
}

model Notification {
  id        String   @id @default(cuid())
  type      String
  title     String
  message   String
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  userId String
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model WhatsappEventRaw {
  id          String    @id @default(uuid())
  receivedAt  DateTime  @default(now())
  instance    String
  eventType   String
  eventKey    String    @unique
  payload     Json
  processed   Boolean   @default(false)
  processedAt DateTime?
  error       String?

  @@index([processed, receivedAt(sort: Desc)])
}

// ===== Enums =====

enum Role {
  ADMIN
  AGENT
}

enum UserStatus {
  ONLINE
  OFFLINE
}

enum ConversationStatus {
  OPEN
  RESOLVED
  PENDING
}

enum Channel {
  WEB
  WHATSAPP
}

enum MessageType {
  TEXT
  FILE
  IMAGE
  AUDIO
}

enum SenderType {
  CONTACT
  USER
  AI_AGENT
}

enum VoiceType {
  MALE
  FEMALE
}
