generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-arm64-openssl-3.0.x", "rhel-openssl-1.0.x", "darwin-arm64"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id              String         @id @default(cuid())
  name            String
  phone           String?
  language        String         @default("pt-BR")
  plan            String         @default("free")
  autoResolvedays Int            @default(30)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  agents          Agent[]
  contacts        Contact[]
  conversations   Conversation[]
  labels          Label[]
  teams           Team[]
  users           User[]
  inboxes         Inbox[]
}

model User {
  id                    String         @id @default(cuid())
  authId                String         @unique
  name                  String
  email                 String         @unique
  avatarUrl             String?
  role                  Role           @default(AGENT)
  status                UserStatus     @default(OFFLINE)
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt
  accountId             String
  assignedConversations Conversation[] @relation("assignee")
  messages              Message[]
  notifications         Notification[]
  teams                 TeamMember[]
  account               Account        @relation(fields: [accountId], references: [id], onDelete: Cascade)
}

model Contact {
  id               String         @id @default(cuid())
  name             String?
  email            String?
  phone            String?
  avatarUrl        String?
  customAttributes Json?          @default("{}")
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  accountId        String
  account          Account        @relation(fields: [accountId], references: [id], onDelete: Cascade)
  labels           ContactLabel[]
  conversations    Conversation[]
}

model Conversation {
  id                String              @id @default(cuid())
  whatsappJid       String?
  status            ConversationStatus  @default(OPEN)
  channel           Channel             @default(WEB)
  unreadCount       Int                 @default(0)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  accountId         String
  contactId         String
  assigneeId        String?
  agentId           String?
  inboxId           String?
  lastReadMessageId String?
  readOverrideUntil DateTime?
  aiEnabled         Boolean             @default(true)
  account           Account             @relation(fields: [accountId], references: [id], onDelete: Cascade)
  agent             Agent?              @relation(fields: [agentId], references: [id])
  assignee          User?               @relation("assignee", fields: [assigneeId], references: [id])
  contact           Contact             @relation(fields: [contactId], references: [id], onDelete: Cascade)
  inbox             Inbox?              @relation(fields: [inboxId], references: [id], onDelete: SetNull)
  labels            ConversationLabel[]
  messages          Message[]

  @@unique([whatsappJid, inboxId])
  @@index([inboxId])
}

model Message {
  id             String       @id @default(cuid())
  whatsappId     String?      @unique
  whatsappJid    String?
  content        String
  type           String       @default("text")
  fromMe         Boolean      @default(false)
  isRead         Boolean      @default(false)
  sender         SenderType
  senderName     String?
  fileUrl        String?
  fileName       String?
  createdAt      DateTime     @default(now())
  conversationId String
  userId         String?
  inboxId        String?
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user           User?        @relation(fields: [userId], references: [id])
  inbox          Inbox?       @relation(fields: [inboxId], references: [id], onDelete: SetNull)

  @@index([inboxId])
  @@index([conversationId])
}


model Inbox {
  id           String   @id @default(cuid())
  name         String
  instanceName String   @unique
  status       String   @default("DISCONNECTED") // CONNECTED, DISCONNECTED
  phoneNumber  String?
  avatarUrl    String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  accountId String
  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  conversations Conversation[]
  messages      Message[]
}

model Agent {
  id                 String           @id @default(cuid())
  name               String
  voiceType          VoiceType        @default(FEMALE)
  prompt             String
  flow               String           @default("QUALIFICATION")
  isActive           Boolean          @default(true)
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  accountId          String
  communicationStyle String           @default("PROFESSIONAL")
  companyDescription String?
  companyName        String           @default("Minha Empresa")
  companyUrl         String?
  groupingDelay      Int              @default(15)
  humanHandoffRules  String           @default("Redirecione para humano em caso de reclamação.")
  messageGrouping    Boolean          @default(true)
  roleDescription    String           @default("Agente de atendimento corporativo.")
  timeBasedRouting   Boolean          @default(false)
  account            Account          @relation(fields: [accountId], references: [id], onDelete: Cascade)
  attributes         AgentAttribute[]
  knowledgeData      AgentKnowledge[]
  conversations      Conversation[]
}

model AgentKnowledge {
  id        String   @id @default(cuid())
  tagName   String
  content   String
  agentId   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  agent     Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
}

model AgentAttribute {
  id          String   @id @default(cuid())
  fieldType   String
  description String
  isRequired  Boolean  @default(false)
  agentId     String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  agent       Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
}

model Label {
  id            String              @id @default(cuid())
  name          String
  description   String?
  color         String              @default("#3B82F6")
  createdAt     DateTime            @default(now())
  accountId     String
  contacts      ContactLabel[]
  conversations ConversationLabel[]
  account       Account             @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@unique([accountId, name])
}

model ContactLabel {
  contactId String
  labelId   String
  contact   Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)
  label     Label   @relation(fields: [labelId], references: [id], onDelete: Cascade)

  @@id([contactId, labelId])
}

model ConversationLabel {
  conversationId String
  labelId        String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  label          Label        @relation(fields: [labelId], references: [id], onDelete: Cascade)

  @@id([conversationId, labelId])
}

model Team {
  id          String       @id @default(cuid())
  name        String
  description String?
  createdAt   DateTime     @default(now())
  accountId   String
  account     Account      @relation(fields: [accountId], references: [id], onDelete: Cascade)
  members     TeamMember[]
}

model TeamMember {
  userId String
  teamId String
  team   Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, teamId])
}

model Notification {
  id        String   @id @default(cuid())
  type      String
  title     String
  message   String
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model WhatsappEventRaw {
  id          String    @id @default(uuid())
  receivedAt  DateTime  @default(now())
  instance    String
  eventType   String
  eventKey    String    @unique
  payload     Json
  processed   Boolean   @default(false)
  processedAt DateTime?
  error       String?

  @@index([processed, receivedAt(sort: Desc)])
}

enum Role {
  ADMIN
  AGENT
}

enum UserStatus {
  ONLINE
  OFFLINE
}

enum ConversationStatus {
  OPEN
  RESOLVED
  PENDING
}

enum Channel {
  WEB
  WHATSAPP
}

enum MessageType {
  TEXT
  FILE
  IMAGE
  AUDIO
}

enum SenderType {
  CONTACT
  USER
  AI_AGENT
}

enum VoiceType {
  MALE
  FEMALE
}
